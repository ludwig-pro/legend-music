<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Audio Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .player-container {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .player-info {
            color: white;
            text-align: center;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .track-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .track-artist {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 16px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .time-display {
            color: #ccc;
            margin-top: 16px;
            font-size: 14px;
        }
        
        .volume-control {
            margin-top: 16px;
        }
        
        .volume-slider {
            width: 200px;
            height: 4px;
            background: #444;
            outline: none;
            border-radius: 2px;
        }
        
        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="player-container" id="playerContainer">
        <div class="player-info">
            <div class="track-title" id="trackTitle">No track loaded</div>
            <div class="track-artist" id="trackArtist">Unknown Artist</div>
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            
            <div class="controls">
                <button class="control-button" id="previousBtn">⏮</button>
                <button class="control-button" id="playPauseBtn">▶️</button>
                <button class="control-button" id="nextBtn">⏭</button>
            </div>
            
            <div class="volume-control">
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
            </div>
        </div>
    </div>

    <audio id="audioElement" preload="auto"></audio>

    <script>
        class LocalAudioPlayer {
            constructor() {
                this.audio = document.getElementById('audioElement');
                this.playerContainer = document.getElementById('playerContainer');
                this.trackTitle = document.getElementById('trackTitle');
                this.trackArtist = document.getElementById('trackArtist');
                this.timeDisplay = document.getElementById('timeDisplay');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.previousBtn = document.getElementById('previousBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.volumeSlider = document.getElementById('volumeSlider');
                
                this.currentTrack = null;
                this.playlist = [];
                this.currentIndex = -1;
                this.isPlaying = false;
                
                this.initializeEventListeners();
                this.setupAudioEvents();
                
                // Set initial volume
                this.audio.volume = 0.5;
                
                console.log('Local Audio Player initialized');
            }
            
            initializeEventListeners() {
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.previousBtn.addEventListener('click', () => this.playPrevious());
                this.nextBtn.addEventListener('click', () => this.playNext());
                this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value / 100));
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.togglePlayPause();
                    } else if (e.code === 'ArrowLeft') {
                        e.preventDefault();
                        this.playPrevious();
                    } else if (e.code === 'ArrowRight') {
                        e.preventDefault();
                        this.playNext();
                    }
                });
            }
            
            setupAudioEvents() {
                this.audio.addEventListener('loadstart', () => {
                    this.postMessage({ type: 'loadstart', data: {} });
                });
                
                this.audio.addEventListener('loadedmetadata', () => {
                    this.updateTimeDisplay();
                    this.postMessage({ 
                        type: 'loadedmetadata', 
                        data: { 
                            duration: this.audio.duration,
                            currentTime: this.audio.currentTime
                        } 
                    });
                });
                
                this.audio.addEventListener('timeupdate', () => {
                    this.updateTimeDisplay();
                    this.postMessage({ 
                        type: 'timeupdate', 
                        data: { 
                            currentTime: this.audio.currentTime,
                            duration: this.audio.duration
                        } 
                    });
                });
                
                this.audio.addEventListener('play', () => {
                    this.isPlaying = true;
                    this.playPauseBtn.textContent = '⏸️';
                    this.postMessage({ type: 'play', data: {} });
                });
                
                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.playPauseBtn.textContent = '▶️';
                    this.postMessage({ type: 'pause', data: {} });
                });
                
                this.audio.addEventListener('ended', () => {
                    this.playNext();
                    this.postMessage({ type: 'ended', data: {} });
                });
                
                this.audio.addEventListener('error', (e) => {
                    console.error('Audio error:', e);
                    this.postMessage({ type: 'error', data: { error: e.message } });
                });
            }
            
            postMessage(message) {
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify(message));
                } else {
                    console.log('LocalAudioPlayer message:', message);
                }
            }
            
            loadTrack(filePath, title, artist) {
                console.log('Loading track:', filePath, title, artist);
                
                this.currentTrack = { filePath, title, artist };
                this.trackTitle.textContent = title || 'Unknown Title';
                this.trackArtist.textContent = artist || 'Unknown Artist';
                
                // Convert file path to file:// URL for local playback
                const fileUrl = filePath.startsWith('file://') ? filePath : `file://${filePath}`;
                this.audio.src = fileUrl;
                
                this.postMessage({ 
                    type: 'trackLoaded', 
                    data: { 
                        filePath, 
                        title, 
                        artist,
                        currentIndex: this.currentIndex
                    } 
                });
                
                return true;
            }
            
            loadPlaylist(playlist, startIndex = 0) {
                console.log('Loading playlist:', playlist.length, 'tracks, starting at index:', startIndex);
                
                this.playlist = playlist;
                this.currentIndex = startIndex;
                
                if (playlist.length > 0 && startIndex < playlist.length) {
                    const track = playlist[startIndex];
                    this.loadTrack(track.filePath, track.title, track.artist);
                }
                
                this.postMessage({ 
                    type: 'playlistLoaded', 
                    data: { 
                        playlist: playlist.map(t => ({ title: t.title, artist: t.artist })),
                        currentIndex: this.currentIndex
                    } 
                });
            }
            
            play() {
                if (this.audio.src) {
                    this.audio.play().catch(e => {
                        console.error('Play failed:', e);
                        this.postMessage({ type: 'error', data: { error: 'Play failed: ' + e.message } });
                    });
                }
            }
            
            pause() {
                this.audio.pause();
            }
            
            togglePlayPause() {
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }
            
            playPrevious() {
                if (this.playlist.length > 0 && this.currentIndex > 0) {
                    this.currentIndex--;
                    const track = this.playlist[this.currentIndex];
                    this.loadTrack(track.filePath, track.title, track.artist);
                    if (this.isPlaying) {
                        this.play();
                    }
                }
            }
            
            playNext() {
                if (this.playlist.length > 0 && this.currentIndex < this.playlist.length - 1) {
                    this.currentIndex++;
                    const track = this.playlist[this.currentIndex];
                    this.loadTrack(track.filePath, track.title, track.artist);
                    if (this.isPlaying) {
                        this.play();
                    }
                }
            }
            
            playTrackAtIndex(index) {
                if (this.playlist.length > 0 && index >= 0 && index < this.playlist.length) {
                    this.currentIndex = index;
                    const track = this.playlist[this.currentIndex];
                    this.loadTrack(track.filePath, track.title, track.artist);
                    this.play();
                }
            }
            
            setVolume(volume) {
                this.audio.volume = Math.max(0, Math.min(1, volume));
                this.volumeSlider.value = volume * 100;
            }
            
            seek(seconds) {
                if (this.audio.duration) {
                    this.audio.currentTime = Math.max(0, Math.min(this.audio.duration, seconds));
                }
            }
            
            updateTimeDisplay() {
                const current = this.formatTime(this.audio.currentTime || 0);
                const duration = this.formatTime(this.audio.duration || 0);
                this.timeDisplay.textContent = `${current} / ${duration}`;
            }
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            getCurrentState() {
                return {
                    isPlaying: this.isPlaying,
                    currentTrack: this.currentTrack,
                    currentTime: this.audio.currentTime || 0,
                    duration: this.audio.duration || 0,
                    volume: this.audio.volume,
                    playlist: this.playlist.map(t => ({ title: t.title, artist: t.artist })),
                    currentIndex: this.currentIndex
                };
            }
        }
        
        // Initialize player
        const player = new LocalAudioPlayer();
        
        // Expose player controls to React Native
        window.localAudioPlayer = {
            loadTrack: (filePath, title, artist) => player.loadTrack(filePath, title, artist),
            loadPlaylist: (playlist, startIndex) => player.loadPlaylist(playlist, startIndex),
            play: () => player.play(),
            pause: () => player.pause(),
            togglePlayPause: () => player.togglePlayPause(),
            playPrevious: () => player.playPrevious(),
            playNext: () => player.playNext(),
            playTrackAtIndex: (index) => player.playTrackAtIndex(index),
            setVolume: (volume) => player.setVolume(volume),
            seek: (seconds) => player.seek(seconds),
            getCurrentState: () => player.getCurrentState()
        };
        
        // Signal that the player is ready
        setTimeout(() => {
            player.postMessage({ type: 'ready', data: {} });
        }, 100);
    </script>
</body>
</html>